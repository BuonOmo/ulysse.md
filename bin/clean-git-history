#!/usr/bin/env zsh

TMP_FILE=$(mktemp XXX.rb)
trap "rm $TMP_FILE" EXIT
revision='82ca6cbb6ea44f919a895f9626765f6082787602'

cat <<-RUBY > $TMP_FILE
squashed = IO.
	readlines(ARGV[0], chomp: true).
	chunk { |line| line["pick aabbccd ".length..] }.
	flat_map { |_, (first, *rest)| [first] + rest.map { _1.sub("pick", "fixup") } }.
	join("\n")

IO.write(ARGV[0], squashed)
RUBY

git -c sequence.editor="ruby $TMP_FILE" rebase -i $revision
sed -i '' "s/^revision=.*/revision='$(git rev-parse HEAD~~)'/" $0

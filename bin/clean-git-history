#!/usr/bin/env zsh

TMP_FILE=$(mktemp XXX.rb)
trap "rm $TMP_FILE" EXIT
revision='ef0146bbc70afc55604eb81ceca11109c9d6bd03'

cat <<-RUBY > $TMP_FILE
squashed = IO.
	readlines(ARGV[0], chomp: true).
	chunk { |line| line["pick aabbccd ".length..] }.
	flat_map { |_, (first, *rest)| [first] + rest.map { _1.sub("pick", "fixup") } }.
	join("\n")

IO.write(ARGV[0], squashed)
RUBY

git -c sequence.editor="ruby $TMP_FILE" rebase --interactive --committer-date-is-author-date $revision
sed -i '' "s/^revision=.*/revision='$(git rev-parse HEAD~~)'/" $0
